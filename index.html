<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xin-Weather 7.0 | æ——èˆ°æ°”è±¡æŒ‡æŒ¥ä¸­å¿ƒ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/vconsole@3.15.1/dist/vconsole.min.js"></script>
    <script>var vConsole = new window.VConsole();</script>

    <style>
        :root { --accent: #3b82f6; }
        body { background: #020617; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .trend-chart { height: 320px; width: 100%; }
        .alert-pulse { animation: alert-glow 2s infinite; }
        @keyframes alert-glow { 0%, 100% { border-color: rgba(239, 68, 68, 0.3); } 50% { border-color: rgba(239, 68, 68, 1); box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); } }
        /* éšè—åŠ è½½åçš„é—ªçƒ */
        [v-cloak] { display: none; }
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 640px) { .text-huge { font-size: 5rem; } }
    </style>
</head>
<body class="antialiased selection:bg-blue-500/30">

<div id="app">
    <div v-if="loading" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black tracking-[0.4em] text-blue-500 uppercase animate-pulse">Data Synchronizing...</p>
    </div>

    <nav class="sticky top-0 z-50 glass border-b border-white/5 px-4 md:px-8 h-20 flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black text-sm">X</div>
            <h1 class="font-black text-lg italic tracking-tighter uppercase hidden sm:block">Xin-Weather <span class="text-blue-500">7.0</span></h1>
        </div>

        <div class="flex-1 max-w-xl relative">
            <input v-model="searchQuery" @keyup.enter="handleSearch" type="text" 
                   placeholder="è¾“å…¥åŸå¸‚åï¼ˆå¦‚ï¼šåŒ—äº¬ï¼‰" 
                   class="w-full bg-white/5 border border-white/10 rounded-2xl py-2.5 px-5 text-sm outline-none focus:border-blue-500/50 transition-all">
            <button @click="handleSearch" class="absolute right-2 top-1.5 bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded-xl text-[10px] font-black transition-all">æ£€ç´¢</button>
        </div>

        <div class="flex items-center gap-2">
            <button @click="autoLocate" class="p-2 hover:bg-white/10 rounded-full text-blue-400" title="é‡æ–°å®šä½">ğŸ›°ï¸</button>
            <button @click="toggleNotify" :class="['hidden md:block p-2 rounded-full transition-all', notifyEnabled ? 'text-green-500' : 'text-slate-500']">ğŸ””</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 lg:p-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-8 space-y-8">
                <div class="glass rounded-[3rem] p-8 md:p-14 relative overflow-hidden group">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-10">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="px-2 py-0.5 bg-blue-600 text-[9px] font-black rounded uppercase">Station Online</span>
                                    <h2 class="text-3xl font-black">{{ location.name }}</h2>
                                </div>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Update: {{ lastSync }}</p>
                            </div>
                            <div class="text-7xl md:text-9xl animate__animated animate__fadeIn">{{ weatherIcon }}</div>
                        </div>

                        <div class="flex flex-col md:flex-row md:items-end gap-4 mb-10">
                            <span class="text-8xl md:text-[10rem] font-black tracking-tighter leading-none">{{ now.temp }}Â°</span>
                            <div class="pb-3">
                                <p class="text-3xl font-bold text-slate-400">{{ now.text }}</p>
                                <p class="text-xs font-black text-blue-500 mt-2 uppercase tracking-widest">Feels Like {{ now.temp }}Â°C</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 pt-10 border-t border-white/5">
                            <div v-for="s in metrics" :key="s.l">
                                <p class="text-[10px] text-slate-500 font-black uppercase mb-1 tracking-widest">{{ s.l }}</p>
                                <p class="text-xl font-black italic">{{ s.v }}<span class="text-[10px] ml-1 opacity-40">{{ s.u }}</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-[3rem] p-8 md:p-10">
                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-slate-500 mb-8">æ°”æ¸©èµ°åŠ¿ç»¼åˆåˆ†æ</h3>
                    <div id="chart" class="trend-chart"></div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-8">
                <div :class="['rounded-[2.5rem] p-8 border transition-all duration-700', isAlert ? 'alert-pulse bg-red-500/5' : 'glass border-white/5']">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Security System</span>
                        <span v-if="isAlert" class="bg-red-600 text-white text-[9px] font-black px-2 py-0.5 rounded animate-bounce">ALERT</span>
                    </div>
                    <h4 :class="['text-xl font-black mb-3', isAlert ? 'text-red-500' : 'text-white']">{{ alertData.title }}</h4>
                    <p class="text-xs text-slate-400 leading-relaxed">{{ alertData.content }}</p>
                </div>

                <div class="glass rounded-[2.5rem] p-8">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-8">3-Day Forecast</h3>
                    <div class="space-y-8">
                        <div v-for="d in daily" :key="d.date" class="flex items-center justify-between group">
                            <div class="w-16">
                                <p class="text-sm font-black">{{ formatDay(d.date) }}</p>
                                <p class="text-[9px] text-slate-500 font-bold">{{ d.date.slice(5) }}</p>
                            </div>
                            <span class="text-2xl group-hover:scale-125 transition-transform">{{ getWeatherEmoji(d.text_day) }}</span>
                            <div class="flex gap-4 font-mono text-sm w-16 justify-end">
                                <span class="font-black">{{ d.high }}Â°</span>
                                <span class="text-slate-600">{{ d.low }}Â°</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-[9px] text-slate-600 mt-8 text-center italic">æ•°æ®æ¥å…¥ï¼šSeniverse Standard API</p>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
/**
 * ==========================================
 * ä¸¥è°¨é…ç½®åŒº
 * ==========================================
 */
const API_KEY = 'S7R3a1RGPf1Do-syp'; // ğŸ‘ˆ å¿…é¡»å¡«å†™ä½ çš„å¿ƒçŸ¥å¤©æ°”ç§é’¥

const { createApp, ref, onMounted, computed, nextTick } = Vue;

createApp({
    setup() {
        const loading = ref(true);
        const searchQuery = ref("");
        const lastSync = ref("--:--");
        const notifyEnabled = ref(false);
        
        const location = ref({ name: "æ­£åœ¨åˆå§‹åŒ–...", id: "" });
        const now = ref({ temp: 0, text: "Loading", code: "99" });
        const daily = ref([]);
        const alertData = ref({ title: "ç³»ç»Ÿå°±ç»ª", content: "æ­£åœ¨è¿æ¥æ°”è±¡å«æ˜Ÿæ•°æ®æº...", guide: "" });
        const isAlert = ref(false);

        const metrics = computed(() => [
            { l: "ç©ºæ°”è´¨é‡", v: "ä¼˜", u: "AQI" },
            { l: "ç›¸å¯¹æ¹¿åº¦", v: "45", u: "%" },
            { l: "é£é€Ÿç­‰çº§", v: "2", u: "çº§" },
            { l: "ç´«å¤–çº¿", v: "å¼±", u: "UV" }
        ]);

        const weatherIcon = computed(() => getWeatherEmoji(now.value.text));

        function getWeatherEmoji(text) {
            if (text.includes("æ™´")) return "â˜€ï¸";
            if (text.includes("äº‘")) return "â˜ï¸";
            if (text.includes("é˜´")) return "ğŸŒ¥ï¸";
            if (text.includes("é›¨")) return "ğŸŒ§ï¸";
            if (text.includes("é›·")) return "â›ˆï¸";
            if (text.includes("é›ª")) return "â„ï¸";
            return "ğŸŒ¤ï¸";
        }

        function formatDay(dateStr) {
            const days = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            return days[new Date(dateStr).getDay()];
        }

        // æ ¸å¿ƒæ•°æ®è°ƒåº¦é€»è¾‘
        const fetchAll = async (city = "ip") => {
            if (!API_KEY || API_KEY === 'YOUR_PRIVATE_KEY') {
                vConsole.log("é”™è¯¯: API_KEY æœªé…ç½®");
                alertData.value = { title: "API KEY ç¼ºå¤±", content: "è¯·åœ¨ä»£ç ç¬¬ 188 è¡Œå¡«å…¥ä½ çš„å¿ƒçŸ¥å¤©æ°”ç§é’¥ã€‚" };
                loading.value = false;
                return;
            }

            try {
                loading.value = true;
                vConsole.log(`å¼€å§‹è¯·æ±‚åŸå¸‚: ${city}`);
                
                // å¹¶å‘è¯·æ±‚ï¼šå®æ—¶ + 3å¤©é¢„æŠ¥
                const [nowRes, dailyRes] = await Promise.all([
                    axios.get(`https://api.seniverse.com/v3/weather/now.json?key=${API_KEY}&location=${city}&language=zh-Hans&unit=c`),
                    axios.get(`https://api.seniverse.com/v3/weather/daily.json?key=${API_KEY}&location=${city}&language=zh-Hans&unit=c&start=0&days=5`)
                ]);

                const resNow = nowRes.data.results[0];
                const resDaily = dailyRes.data.results[0];

                location.value.name = resNow.location.name;
                now.value = {
                    temp: resNow.now.temperature,
                    text: resNow.now.text,
                    code: resNow.now.code
                };
                daily.value = resDaily.daily;

                // é¢„è­¦é€»è¾‘åˆ¤æ–­
                const tempNum = parseInt(now.value.temp);
                if (tempNum > 35 || now.value.text.includes("é›¨") || now.value.text.includes("é›ª")) {
                    isAlert.value = true;
                    alertData.value = { 
                        title: "æ¶åŠ£å¤©æ°”æé†’", 
                        content: `å½“å‰æ£€æµ‹åˆ° ${now.value.text} å¤©æ°”ï¼Œæ°”æ¸© ${now.value.temp}Â°Cã€‚è¯·æ³¨æ„é˜²èŒƒã€‚` 
                    };
                    if (notifyEnabled.value) new Notification("æ°”è±¡é¢„è­¦", { body: alertData.value.content });
                } else {
                    isAlert.value = false;
                    alertData.value = { title: "æ°”è±¡å¹³ç¨³", content: "å½“å‰åŒºåŸŸæš‚æ— æç«¯å¤©æ°”ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨ã€‚" };
                }

                lastSync.value = new Date().toLocaleTimeString();
                nextTick(renderChart);
            } catch (err) {
                vConsole.error("æ•°æ®è¯·æ±‚å¤±è´¥", err);
                alertData.value = { title: "åŒæ­¥å¤±è´¥", content: "æ— æ³•è·å–æ°”è±¡æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API é¢åº¦ã€‚" };
            } finally {
                loading.value = false;
            }
        };

        const handleSearch = () => {
            if (searchQuery.value.trim()) {
                fetchAll(searchQuery.value.trim());
                searchQuery.value = "";
            }
        };

        const autoLocate = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchAll(`${p.coords.latitude}:${p.coords.longitude}`),
                    () => fetchAll("ip"), // å¤±è´¥åˆ™é€šè¿‡ IP è‡ªåŠ¨è¯†åˆ«
                    { timeout: 5000 }
                );
            } else {
                fetchAll("beijing");
            }
        };

        const toggleNotify = async () => {
            const p = await Notification.requestPermission();
            notifyEnabled.value = (p === 'granted');
        };

        let chart = null;
        const renderChart = () => {
            const el = document.getElementById('chart');
            if (!el || !daily.value.length) return;
            if (chart) chart.dispose();
            chart = echarts.init(el, 'dark');
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                grid: { top: '10%', bottom: '15%', left: '5%', right: '5%' },
                xAxis: { type: 'category', data: daily.value.map(d => formatDay(d.date)), axisLine: { show: false } },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.03)' } }, axisLabel: { show: false } },
                series: [
                    {
                        name: 'æœ€é«˜æ¸©', type: 'line', smooth: true,
                        data: daily.value.map(d => d.high),
                        lineStyle: { color: '#3b82f6', width: 4 },
                        symbol: 'circle', symbolSize: 10,
                        itemStyle: { color: '#3b82f6' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.2)' },
                                { offset: 1, color: 'transparent' }
                            ])
                        }
                    }
                ]
            };
            chart.setOption(option);
        };

        onMounted(() => {
            autoLocate();
            window.addEventListener('resize', () => chart && chart.resize());
        });

        return {
            loading, searchQuery, lastSync, notifyEnabled, location, now, daily,
            alertData, isAlert, metrics, weatherIcon, handleSearch, autoLocate, toggleNotify,
            getWeatherEmoji, formatDay
        };
    }
}).mount('#app');
</script>
</body>
</html>
