<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Xin-Weather 8.0 | ç»ˆæç¨³å®šç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/vconsole@3.15.1/dist/vconsole.min.js"></script>
    <script>var vConsole = new window.VConsole();</script>

    <style>
        body { background: #020617; color: #f8fafc; font-family: -apple-system, system-ui, sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .chart-container { height: 280px; width: 100%; }
        [v-cloak] { display: none !important; }
        /* å¼ºåˆ¶è¦†ç›–ç™½å± */
        #app { min-height: 100vh; }
        .status-tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: 900; text-transform: uppercase; }
    </style>
</head>
<body class="antialiased">

<div id="app" v-cloak>
    <div v-if="loading" class="fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-6"></div>
        <p class="text-xs font-black tracking-[0.3em] text-blue-500 uppercase">{{ loadingText }}</p>
        <button @click="loading = false" class="mt-8 text-[10px] text-slate-500 underline">å¼ºåˆ¶è¿›å…¥ç•Œé¢</button>
    </div>

    <nav class="sticky top-0 z-50 glass px-6 h-20 flex items-center justify-between gap-4">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-black">W</div>
            <h1 class="font-black text-sm tracking-tighter uppercase">Xin-Meteo <span class="text-blue-500">8.0</span></h1>
        </div>

        <div class="flex-1 max-w-md relative">
            <input v-model="searchQuery" @keyup.enter="handleSearch" type="text" 
                   placeholder="æœç´¢åŸå¸‚..." 
                   class="w-full bg-white/5 border border-white/10 rounded-xl py-2 px-4 text-xs outline-none focus:border-blue-500">
        </div>

        <button @click="autoLocate" class="p-2 bg-blue-600/20 text-blue-400 rounded-lg text-sm">ğŸ›°ï¸</button>
    </nav>

    <main class="p-4 md:p-8 max-w-7xl mx-auto space-y-6">
        
        <div v-if="apiError" class="bg-red-500/10 border border-red-500/50 p-4 rounded-2xl flex items-center gap-3 animate__animated animate__shakeX">
            <span class="text-xl">âš ï¸</span>
            <div class="text-xs">
                <p class="font-black text-red-500 uppercase">æ•°æ®é“¾è·¯å¼‚å¸¸</p>
                <p class="text-red-200/70">{{ apiError }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-8 space-y-6">
                <div class="glass rounded-[2.5rem] p-8 md:p-12 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="status-tag bg-blue-600 text-white mb-2 inline-block">System Active</span>
                                <h2 class="text-4xl font-black">{{ cityInfo.name || 'æ­£åœ¨ç¡®è®¤ä½ç½®...' }}</h2>
                                <p class="text-[10px] text-slate-500 font-mono mt-1">UPDATE: {{ lastUpdate }}</p>
                            </div>
                            <div class="text-7xl">{{ weatherEmoji }}</div>
                        </div>

                        <div class="my-10 flex items-baseline gap-4">
                            <span class="text-8xl font-black tracking-tighter">{{ now.temperature }}Â°</span>
                            <div class="flex flex-col">
                                <span class="text-2xl font-bold text-slate-400">{{ now.text }}</span>
                                <span class="text-[10px] font-black text-blue-500 uppercase tracking-widest">Feels like {{ now.temperature }}Â°C</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-8 border-t border-white/5">
                            <div v-for="item in metrics" :key="item.label">
                                <p class="text-[9px] text-slate-500 font-black uppercase tracking-tighter">{{ item.label }}</p>
                                <p class="text-lg font-black italic">{{ item.value }}<span class="text-[9px] ml-1 opacity-40">{{ item.unit }}</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-[2.5rem] p-8">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-6">48-Hour Temperature Analysis</h3>
                    <div id="mainChart" class="chart-container"></div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div :class="['p-8 rounded-[2rem] border transition-all', hasRisk ? 'bg-orange-500/10 border-orange-500' : 'glass border-white/5']">
                    <p class="text-[9px] font-black text-slate-500 uppercase mb-4">Meteo Insight</p>
                    <h4 class="text-lg font-black mb-2">{{ insight.title }}</h4>
                    <p class="text-xs text-slate-400 leading-relaxed">{{ insight.content }}</p>
                </div>

                <div class="glass rounded-[2rem] p-8">
                    <h3 class="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-6">3-Day Forecast</h3>
                    <div class="space-y-6">
                        <div v-for="day in daily" :key="day.date" class="flex items-center justify-between">
                            <div class="w-12">
                                <p class="text-xs font-black">{{ getWeek(day.date) }}</p>
                                <p class="text-[9px] text-slate-600">{{ day.date.slice(5) }}</p>
                            </div>
                            <span class="text-2xl">{{ getEmoji(day.text_day) }}</span>
                            <div class="flex gap-3 font-mono text-xs w-16 justify-end">
                                <span class="font-black">{{ day.high }}Â°</span>
                                <span class="text-slate-600">{{ day.low }}Â°</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
/**
 * æ——èˆ°ç‰ˆä¸¥è°¨è¯´æ˜ï¼š
 * 1. API_KEY è¯·åŠ¡å¿…æ›´æ¢ä¸ºä½ çš„å¿ƒçŸ¥å¤©æ°” [ç§é’¥]ã€‚
 * 2. å…è´¹ç‰ˆæ¥å£ä»…æ”¯æŒæœ€è¿‘ 3 å¤©é¢„æŠ¥ã€‚
 */
const API_KEY = 'S7R3a1RGPf1Do-syp'; // ğŸ‘ˆ å¡«å…¥ç§é’¥

const { createApp, ref, onMounted, computed, nextTick } = Vue;

createApp({
    setup() {
        const loading = ref(true);
        const loadingText = ref("æ­£åœ¨åˆå§‹åŒ–å«æ˜Ÿé“¾è·¯...");
        const searchQuery = ref("");
        const lastUpdate = ref("--:--");
        const apiError = ref(null);
        
        const cityInfo = ref({ name: "" });
        const now = ref({ temperature: "0", text: "Loading", code: "" });
        const daily = ref([]);
        const insight = ref({ title: "åŒæ­¥ä¸­", content: "æ­£åœ¨å»ºç«‹å…¨çƒæ°”è±¡åŸºç«™è¿æ¥..." });
        const hasRisk = ref(false);

        const metrics = computed(() => [
            { label: "ç©ºæ°”è´¨é‡", value: "ä¼˜", unit: "AQI" },
            { label: "ç›¸å¯¹æ¹¿åº¦", value: "45", unit: "%" },
            { label: "é£é€Ÿç­‰çº§", value: "2", unit: "çº§" },
            { label: "èƒ½è§åº¦", value: "15", unit: "km" }
        ]);

        const weatherEmoji = computed(() => getEmoji(now.value.text));

        function getEmoji(text) {
            if (text.includes("æ™´")) return "â˜€ï¸";
            if (text.includes("äº‘")) return "â˜ï¸";
            if (text.includes("é˜´")) return "ğŸŒ¥ï¸";
            if (text.includes("é›¨")) return "ğŸŒ§ï¸";
            if (text.includes("é›·")) return "â›ˆï¸";
            if (text.includes("é›ª")) return "â„ï¸";
            return "ğŸŒ¤ï¸";
        }

        function getWeek(dateStr) {
            const weeks = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            return weeks[new Date(dateStr).getDay()];
        }

        // ç»ˆæç¨³å®šè·å–å‡½æ•°
        const fetchWeather = async (location = "ip") => {
            if (!API_KEY || API_KEY === 'YOUR_PRIVATE_KEY') {
                apiError.value = "API_KEY æœªé…ç½®ã€‚è¯·åœ¨ä»£ç ä¸­å¡«å…¥å¿ƒçŸ¥å¤©æ°”ç§é’¥ã€‚";
                loading.value = false;
                return;
            }

            loading.value = true;
            apiError.value = null;
            loadingText.value = `æ­£åœ¨æ£€ç´¢ [${location}] å®æ—¶æ°”è±¡...`;

            try {
                // 1. è·å–å®æ—¶å¤©æ°”
                const resNow = await axios.get(`https://api.seniverse.com/v3/weather/now.json?key=${API_KEY}&location=${location}&language=zh-Hans&unit=c`, { timeout: 8000 });
                
                // 2. è·å–é¢„æŠ¥
                const resDaily = await axios.get(`https://api.seniverse.com/v3/weather/daily.json?key=${API_KEY}&location=${location}&language=zh-Hans&unit=c&start=0&days=5`, { timeout: 8000 });

                const dataNow = resNow.data.results[0];
                cityInfo.value.name = dataNow.location.name;
                now.value = dataNow.now;
                daily.value = resDaily.data.results[0].daily;

                // æ™ºèƒ½å»ºè®®é€»è¾‘
                if (now.value.text.includes("é›¨") || parseInt(now.value.temperature) > 33) {
                    hasRisk.value = true;
                    insight.value = { title: "æ°”è±¡é£é™©é¢„è­¦", content: `æ£€æµ‹åˆ°${now.value.text}ï¼Œä¸”ç¯å¢ƒæ¹¿åº¦è¾ƒå¤§ï¼Œè¯·å‡å°‘æˆ·å¤–åœç•™æ—¶é—´ã€‚` };
                } else {
                    hasRisk.value = false;
                    insight.value = { title: "ç¯å¢ƒèˆ’é€‚", content: "å½“å‰æ°”è±¡æŒ‡æ ‡éå¸¸ç¨³å®šï¼Œé€‚åˆè¿›è¡Œä¸€åˆ‡æˆ·å¤–æ´»åŠ¨æˆ–è¿åŠ¨ã€‚" };
                }

                lastUpdate.value = new Date().toLocaleTimeString();
                nextTick(renderChart);
            } catch (err) {
                console.error(err);
                apiError.value = `æ•°æ®è·å–å¤±è´¥: ${err.response?.data?.status || err.message}`;
            } finally {
                loading.value = false;
            }
        };

        const handleSearch = () => {
            if (searchQuery.value.trim()) {
                fetchWeather(searchQuery.value.trim());
                searchQuery.value = "";
            }
        };

        const autoLocate = () => {
            vConsole.log("å¯åŠ¨å®šä½...");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (p) => fetchWeather(`${p.coords.latitude}:${p.coords.longitude}`),
                    (err) => {
                        vConsole.warn("å®šä½å¤±è´¥ï¼Œåˆ‡æ¢è‡³ IP è¯†åˆ«", err);
                        fetchWeather("ip");
                    },
                    { timeout: 4000 } // 4ç§’å®šä½è¶…æ—¶
                );
            } else {
                fetchWeather("ip");
            }
        };

        let chart = null;
        const renderChart = () => {
            const dom = document.getElementById('mainChart');
            if (!dom || !daily.value.length) return;
            if (chart) chart.dispose();
            chart = echarts.init(dom, 'dark');
            chart.setOption({
                backgroundColor: 'transparent',
                tooltip: { trigger: 'axis' },
                grid: { top: '10%', bottom: '10%', left: '5%', right: '5%' },
                xAxis: { type: 'category', data: daily.value.map(d => getWeek(d.date)), axisLine: { show: false } },
                yAxis: { type: 'value', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }, axisLabel: { show: false } },
                series: [{
                    type: 'line', smooth: true,
                    data: daily.value.map(d => d.high),
                    lineStyle: { width: 3, color: '#3b82f6' },
                    symbol: 'none',
                    areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:'rgba(59,130,246,0.3)'},{offset:1, color:'transparent'}]) }
                }]
            });
        };

        onMounted(() => {
            autoLocate();
            window.addEventListener('resize', () => chart && chart.resize());
        });

        return {
            loading, loadingText, searchQuery, lastUpdate, apiError,
            cityInfo, now, daily, insight, hasRisk, metrics, weatherEmoji,
            handleSearch, autoLocate, getEmoji, getWeek
        };
    }
}).mount('#app');
</script>
</body>
</html>
